{% extends "base.html" %}
{% block title %}Faculty · Intelligent Timetable{% endblock %}

{% block content %}

<div class="section-header">
    <h2>Faculty Dashboard</h2>
    <span>Weekly schedule for {{ user.username }}</span>
</div>

<div class="actions mb-4">
  <a href="{{ url_for('main.faculty_request_leave') }}" class="btn btn-primary">
    Request Leave / Unavailability
  </a>
</div>

<div class="row g-4">
    <div class="col-md-4">
        <!-- your overview card stays as you like -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-2">Overview</h5>
                <p class="text-muted-soft mb-2">
                    Auto-generated load for the week.
                </p>
                <!-- mock / calculated stats can go here -->
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="card-title mb-0">Your Timetable</h5>
                </div>
                <p class="text-muted-soft mb-2">
                    Generated from the latest timetable. Empty slots show "No Class".
                </p>

                {% if days and periods %}
                <div class="timetable-wrapper">
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Day / Time</th>
                                {% for start, end in periods %}
                                    <th>
                                        <div class="time-range">
                                            {{ start.strftime('%H:%M') }}<br>
                                            - {{ end.strftime('%H:%M') }}
                                        </div>
                                    </th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for day_index, day_label in days %}
                            <tr>
                                <td class="day-label">{{ day_label }}</td>

                                {% for p_idx in range(periods|length) %}
                                    {% set entry = grid.get((day_index, p_idx)) %}
                                    <td class="tt-cell">
                                        {% if entry %}
                                            <div class="tt-course">
                                                {{ entry.subject.code }} {{ entry.subject.name }}
                                            </div>
                                            <div class="tt-room">
                                                {{ entry.room.name }}
                                            </div>
                                            <div class="tt-faculty">
                                                {{ entry.faculty.name }}
                                            </div>
                                            <div class="tt-section">
                                                {{ entry.batch.name }}
                                            </div>
                                        {% else %}
                                            <div class="tt-empty">No Class</div>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                    <p class="text-muted-soft mb-0">
                        No timetable generated yet for you.
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<h3>Your Leave / Unavailability Requests</h3>
<table border="1" cellpadding="6" cellspacing="0">
  <tr>
    <th>ID</th>
    <th>Day</th>
    <th>Timeslot</th>
    <th>Status</th>
    <th>Reason</th>
  </tr>
  {% for r in requests %}
  <tr>
    <td>{{ r.id }}</td>
    <td>{{ r.day_of_week }}</td>
    <td>
      {% if r.timeslot %}
        {{ r.timeslot.start_time.strftime("%H:%M") }}–{{ r.timeslot.end_time.strftime("%H:%M") }}
      {% else %}
        Full Day
      {% endif %}
    </td>
    <td>{{ r.status }}</td>
    <td>{{ r.reason }}</td>
  </tr>
  {% else %}
  <tr>
    <td colspan="5">No leave requests yet.</td>
  </tr>
  {% endfor %}
</table>

<h3>Notifications</h3>
<table border="1" cellpadding="6" cellspacing="0">
  <tr>
    <th>Message</th>
    <th>Time</th>
  </tr>
  {% for n in notifications %}
  <tr>
    <td>{{ n.message }}</td>
    <td>{{ n.created_at }}</td>
  </tr>
  {% else %}
  <tr>
    <td colspan="2">No notifications.</td>
  </tr>
  {% endfor %}
</table>

<div class="card" style="margin-top: 24px;">
  <h3>AI Scheduling Assistant</h3>
  <div id="chat-log" style="height: 250px; overflow-y: auto; border: 1px solid #ccc; padding: 8px; border-radius: 8px; margin-bottom: 8px; font-size: 0.9rem;">
    <div><strong>Bot:</strong> Hi! I can help you analyse and reschedule timetables. Ask me anything.</div>
  </div>
  <div style="display: flex; gap: 8px;">
    <input id="chat-input" type="text" placeholder="Ask about timetable or rescheduling..."
           style="flex: 1; padding: 6px 10px; border-radius: 6px; border: 1px solid #aaa;">
    <button id="chat-send" type="button">Send</button>
  </div>
</div>

<script>
  const chatLog = document.getElementById("chat-log");
  const chatInput = document.getElementById("chat-input");
  const chatSend = document.getElementById("chat-send");

  function appendMessage(sender, text) {
    const div = document.createElement("div");
    div.innerHTML = `<strong>${sender}:</strong> ${text}`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  async function sendMessage() {
    const text = chatInput.value.trim();
    if (!text) return;
    appendMessage("You", text);
    chatInput.value = "";

    try {
      const res = await fetch("{{ url_for('main.chat_api') }}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message: text })
      });

      const data = await res.json();
      if (data.reply) {
        appendMessage("Bot", data.reply);
      }
      if (data.execution_result) {
          appendMessage("System", data.execution_result.message);
          if (data.execution_result.success) {
              // optional refresh
              // location.reload();
          }
      }
      if (!data.reply && !data.execution_result) {
        appendMessage("Bot", "Unexpected response from server.");
      }
    } catch (err) {
      appendMessage("Bot", "Network error.");
    }
  }

  chatSend.addEventListener("click", sendMessage);
  chatInput.addEventListener("keydown", function(e) {
    if (e.key === "Enter") sendMessage();
  });
</script>

{% endblock %}